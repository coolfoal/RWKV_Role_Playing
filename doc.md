## 一些关于角色扮演方面的技巧

这篇文章主要是想谈一谈关于玩了这么长时间rwkv角色扮演的心得，也是想和对rwkv角色扮演感兴趣的诸位做一个交流，里面的很多内容我只是做了一些很感性的判断，并没有严格的数据支撑，如果你觉得有用，那么便是最好，如果没用……其实也正常，我经常碰到某些技巧在今天表现的很好，第二天重启程序就表现不佳的问题，我会在文章中提一嘴这种技巧，权当是给自己做个备忘，以后有机会再尝试。

以下内容都是针对rwkv6系列模型，我不是很擅长组织清晰且富有逻辑性的语言，所以在这里，我还是使用FAQ的方式来叙述。

### 1. 我该如何编写角色卡呢？

这是玩AI角色扮演的第一步，也是很重要的一步，我最近更新了项目中的示例角色“小雪”，这个示例中，也包含了很多我对rwkv6系列模型进行角色扮演的理解，因为篇幅限制，我就不在这里把这个示例角色的内容贴在这里了，大概讲解一下思路吧。
大家应该都知道大模型有一个叫初始prompt的东西，网上有很多关于chatgpt，claude，bing等模型的初始prompt分享，其实rwkv也一样，给一个好的初始prompt能够使之后生成的内容更加符合需求，而角色设定就担当了这个初始prompt的职责，如果按照我的角色卡格式来进行角色设定的话，那么这个初始prompt分为了三块，即：示例对话，角色设定，开场白。这三者也按照这样的顺序，作为初始prompt“喂”给模型。

> “System: 初始prompt”这样的格式在rwkv中并不好使，经过我个人的一些测试，System这样的角色在rwkv中似乎并不存在，模型不会因为你在prompt前加了System就认为这是系统命令，我甚至觉得加了这样的东西反而会使角色扮演效果变得更差。

示例对话：这部分直接影响了模型扮演的角色如何说话，但也是很不好写的部分，毕竟要写很多文字嘛，不过换个思路，示例对话也是初始prompt中的一部分，那么它也是可以当做角色设定来写的，那么不妨把角色设定中的部分内容给拿出来，让角色通过自己的语言介绍出来，这样即丰富了角色的形象风格，又节省了角色设定中的token，妥妥的利大于弊，我在“小雪”这个示例角色中也是按照这个思路来编写的，让角色介绍完自己后，然后再针对性的进行一些追问或者发散，这样几个来回，三四段对话就有了，示例对话也算是编写完成了。
我个人建议，使用（）来表示角色的动作或者第三人称的描写，在我的程序中对这样的字符有一些特殊处理，这点我们放在后面说。

角色设定：如果你添加了示例对话，那么可以在这里追加一些在示例对话中没有表现出来的设定，如果你没有添加示例对话，那么可以把角色信息都写在这里，就直接用文字来描述即可，不用考虑什么花活（比如用xml标签啊，或者搞一些markdown格式之类的，这些我测试过，没什么效果甚至会有反效果），rwkv是可以理解你描述的内容的（准不准确或者能不能全记住另说，你让它复述倒是没啥问题，融会贯通上仍有不足）。
另外，我强烈建议在角色设定前面加上“请你阅读以下内容，并扮演{{char}}，而我则扮演{{user}}。”这样的话，{{char}}和{{user}}是占位符，指代角色名和玩家名，我觉得rwkv是做过相应的训练的，当你明确的告诉模型你要搞角色扮演，模型输出的效果就是比不告诉模型要强，我没有给这样的话集成在程序中，主要是方便尝试其他的指令，也许以后会发现更好地指令。对了，用老奶奶威胁或者给钱奖励什么的好像有用（效果似乎只能持续一轮或者两轮），但我不能完全确定，诸位有兴趣可以尝试一下。

开场白：这个就很好办了，可以在其中加入时间地点人物等内容，这个开场白与其说是帮AI理解人物，倒不如说是让玩家更好的进入角色扮演模式，所以别弄点儿只有一两个字的开场白，不然你自己都不知道要怎么接话，如果没有加示例对话的话，这个开场白也起到一定程度上示例对话作用，效果肯定没有示例对话好，但还是在一定程度上能实现让AI遵循你想要的输出规则来说话这样的功能。

> 为什么初始prompt是示例对话->角色设定->开场白这样的顺序呢？这里我主要是参考了Bo在chatrwkv这个项目里对角色扮演初始prompt的写法，我也尝试过角色设定->示例对话->开场白这样的顺序，效果不是很好，主要示例对话会和开场白冲突，我也尝试过用一些承上启下的文字将他们隔开，但效果并没有比示例对话->角色设定->开场白这样的顺序更好，所以本着token能省就省的原则，就还是这么保持了，于是就有了现在的初始prompt：
```
示例对话

角色设定

开场白
```

在使用rwkv6-world-v2之后的模型时，我已经不太建议使用User/Assistant来替换玩家名/角色名了，一方面使用User/Assistant更容易让回复陷入定式，另一方面，也无法体验本程序新增加的一个多角色的功能，所获得的只有一些回答的合理性（而且还是带着gpt味儿的合理性），实在是得不偿失，但我还是保留此功能作为测试用。

### 2. 为什么你程序里的聊天参数这么怪？

主要是我的这程序主要是用来做角色扮演的，而不是做AI助手的，所以我更想让回复变得丰富多彩（？）一些，常见的topp采样在几轮对话之后，就会陷入一种被称为“无聊陷阱”的怪圈中，无论怎么重试，AI回复的内容中总是带着大量的重复，据说这玩意儿是自回归模型的通病，我个人并不是很懂。
后来我接触了mirostat这种采样方式，参考了几个项目之后，我尝试着实现了它，这种采样方式的确能输出更长一些的内容，并且相对不容易重样，所以我就将我程序的推理采样方案改成了这种，但是吧，用了一段时间之后，发现虽然的确不重样了，但是内容也相对的不合理了，之后我又引入了minp这个采样方案，来控制一下这个采样器的放飞程度，后来又引入了温度这个参数，再增加一些随机性，最后就变成了现在这个样子了。
老实说，这么折腾就是为了防止重复，那么现在的效果好吗？相比topp采样，效果是好了，但是仍然没有达到内容新颖，逻辑准确的地步（这里主要说的是一次性生成的情况，多次重试不算，至少现在多重试几次还是能有效果好的文字出现的），即使14B也是如此，不过在最近的尝试中，我还是很欣喜的发现Bo的rwkv6-world-v3-7B在没训练完成的情况下，角色扮演效果也比以前强（是不是真的比14B强我还需要更长的时间来比较），至少我可以乐观的认为在角色扮演的领域数据的质量比模型尺寸更重要，rwkv系列模型无论是数据还是模型尺寸还是架构都还有很长的路走，构建一个独属于自己的角色已经完全不是梦想了。

### 3. 在聊天期间，有什么好的建议吗？

很系统的建议，说实在的，没有。
就随便聊一些自己在玩的时候遇到的一些问题和解决方案吧，我个人遇到的，也是我在一直想办法解决的，主要就是重复回复的问题，聊着聊着，AI回复我的内容就陷入到某种定式了，这点在使用（）加入对角色动作描写时尤其明显，所以我尝试着在检测到“（”出现时，让下一个token的输出更随机一些，我这里用的方法是选择概率最高的前20个token作为候选，然后使用极大的温度对着20个token的候选概率进行处理，让它们被选到的概率相差不多（当然，概率高的还是被选择的概率更高一些，但至少不至于回回都是它了），这样“（”之后的第一个token不一样了，会在一定程度上带着后面输出的内容和前文不一样，在一定程度上即保证了输出内容的合理性，又保证了输出内容的多样性，只不过这种处理方式比较依赖格式，你要是用“**”来包裹角色动作的话，这招就不好使了，另外，这招对英文也不太好使，所以目前我就只检测了“（”这个字符，另外，我之前也尝试过将对话用‘“”’来包裹，这样我也可以在检测到‘“’后，用同样的方法来处理‘“’后的第一个token，这样也能让对话内容也尽量不重样，但是也可能是模型训练数据的问题，使用‘“”’包裹对话内容后，似乎触发了小说续写的开关，会让AI自顾自的往下写，所以这招我也放弃了。
在“说些什么吧”这个文本框下面有一个“希望谁来回复”的输入框，这里一般情况下，会自动填入角色的名字，但如果你想要别的角色（比如你在剧情中引入了一个敌人）来回复你，那么可以直接在这里填入这个角色的名字，然后点提交，那么AI会根据当前剧情，扮演你填入的这个角色来回复你，从而来进行更丰富的互动。或者当角色施展了一个魔法，但是在回复中并没有很好的对这个场面进行描写时，这时候你可以在这个文本框中输入“对xx施展魔法的描写”，然后点击提交，那么AI会以旁白的口吻对xx角色施展的魔法再描写一次，让剧情能够更丰富一些。也许它还能变成角色的状态栏，供玩家在想要的时候就调出来，但是我没有这么玩过，而且我也不太确定我现在的采样方案适不适合输出这种固定格式的内容，有想法的玩家可以试试看。
最后一个建议就是多用重新生成这个按钮吧，也不知道是不是我魔改太多的缘故，导致在进行十几轮对话之后，一次生成就到位的概率就没那么高了，需要多生成个几次才行（就算这样，也感觉比以前强多了，至少多按几次还能输出满意的结果，现在基本上已经用不上“替角色说”这样的功能了），另外我发现，模型的上下文限制基本上没啥用了，rwkv系列模型普遍上下文长度是4k，但是我经常聊了8k甚至12k的上下文了，模型依然能够很好的继续生成我想要的内容，这点确实有点出乎意料。

### 4. 模型对于R18/R18G方面的表现好吗？

我个人的感觉是：好。而且也不需要像其他的模型还需要考虑破限什么的，不过由于我个人性癖有限，无法（也不想）测试到所有绅士玩法，在这里我还是无法把话说死，也许还是有没有训练到的地方。但是吧，这玩意儿确实也不太好反馈，毕竟谁也不想拿着自己的性癖到处讨论嘛，就算匿名也不想，所以这事儿还是圈地自萌吧，自己去试试，觉得好，那就好。